<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
    <title>Nonna Vittoria Apartments</title>
    
    <!-- Meta tags principali -->
    <meta name="description" content="Nonna Vittoria Apartments - Il tuo soggiorno in Puglia" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    
    <!-- Tema e colori -->
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)" />
    
    <!-- PWA meta tags -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="Nonna Vittoria Apartments" />
    
    <!-- iOS meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Nonna Vittoria Apartments" />
    
    <!-- Prevenzione caching versione PWA -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <!-- Manifest e icone base -->
    <link rel="manifest" href="/manifest.json" crossorigin="use-credentials" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png" />
    <!-- Icone per iOS ottimizzate -->
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/icon-167x167.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="/splash/iPhone_14_Pro_Max_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="/splash/iPhone_14_Pro_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="/splash/iPhone_14_Plus__iPhone_13_Pro_Max__iPhone_12_Pro_Max_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/splash/iPhone_14__iPhone_13_Pro__iPhone_13__iPhone_12_Pro__iPhone_12_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="/splash/iPhone_13_mini__iPhone_12_mini__iPhone_11_Pro__iPhone_XS__iPhone_X_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" href="/splash/iPhone_11_Pro_Max__iPhone_XS_Max_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" href="/splash/iPhone_11__iPhone_XR_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)" href="/splash/iPhone_8_Plus__iPhone_7_Plus__iPhone_6s_Plus__iPhone_6_Plus_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="/splash/iPhone_8__iPhone_7__iPhone_6s__iPhone_6__4.7__iPhone_SE_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" href="/splash/4__iPhone_SE__iPod_touch_5th_generation_and_later_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" href="/splash/12.9__iPad_Pro_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" href="/splash/11__iPad_Pro__10.5__iPad_Pro_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2)" href="/splash/10.9__iPad_Air_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" href="/splash/10.5__iPad_Air_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2)" href="/splash/10.2__iPad_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" href="/splash/9.7__iPad_Pro__7.9__iPad_mini__9.7__iPad_Air__9.7__iPad_portrait.png" />
    <link rel="apple-touch-startup-image" media="screen and (device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2)" href="/splash/8.3__iPad_Mini_portrait.png" />

    <!-- Script per OneSignal -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "8d05cb31-99c9-4dd2-a2a9-8e7fb838fb8a",
    });
  });
</script>

<script>
  // Previene il redirect infinito durante l'installazione
  if (window.location.search.includes('pwa=true')) {
    window.history.replaceState({}, document.title, window.location.pathname);
  }

  // Gestione standalone mode
  if (window.matchMedia('(display-mode: standalone)').matches) {
    // Siamo già in modalità standalone/PWA
    console.log('App in modalità standalone');
  }
</script>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Stili base e fix per PWA -->
    <style>
      /* Reset e stili base */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      :root {
        --vh: 1vh;
        --safe-area-inset-top: env(safe-area-inset-top);
        --safe-area-inset-bottom: env(safe-area-inset-bottom);
      }

      html {
        height: 100%;
        height: -webkit-fill-available;
        overflow: hidden;
      }

      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        height: calc(var(--vh, 1vh) * 100);
        overflow: hidden;
        position: fixed;
        width: 100%;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #ffffff;
        overscroll-behavior-y: none;
        padding-top: var(--safe-area-inset-top);
        padding-bottom: var(--safe-area-inset-bottom);
      }

      /* Fix per modalità standalone */
      @media all and (display-mode: standalone) {
        body {
          padding-top: var(--safe-area-inset-top);
        }

        .vipHeroContainer.extended-blue-bg {
          padding-top: var(--safe-area-inset-top);
        }
      }

      /* Dark mode */
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #1a1a1a;
          color: #ffffff;
        }
      }

      /* Fix per iOS */
      @supports (-webkit-touch-callout: none) {
        body {
          min-height: -webkit-fill-available;
        }

        .ios-safe-area-top {
          padding-top: var(--safe-area-inset-top);
        }

        .ios-safe-area-bottom {
          padding-bottom: var(--safe-area-inset-bottom);
        }
      }

      /* Stili per lo scrolling */
      .scroll-container {
        height: 100%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior-y: none;
      }

      /* Fix per l'effetto "rubber band" su iOS */
      .prevent-overscroll {
        overscroll-behavior-y: none;
        -webkit-overflow-scrolling: touch;
      }
    </style>

    <!-- Script per la gestione della PWA -->
    <script>
      // Utility per gestire l'altezza viewport su mobile
      function setViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }

      // Handler per l'installazione della PWA
      let deferredPrompt;

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log('PWA installabile');
      });

      window.addEventListener('appinstalled', () => {
        deferredPrompt = null;
        localStorage.setItem('pwa-installed', 'true');
        console.log('PWA installata con successo');
      });

      // Gestione dimensioni viewport
      window.addEventListener('resize', setViewportHeight);
      window.addEventListener('orientationchange', () => {
        setTimeout(setViewportHeight, 100);
      });

      // Inizializzazione
      document.addEventListener('DOMContentLoaded', () => {
        setViewportHeight();
        
        // Controllo stato PWA
        if (window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true) {
          document.body.classList.add('standalone-mode');
        }
      });

      // Gestione versione PWA
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/serviceworker.js')
          .then(registration => {
            console.log('Service Worker registrato');
          })
          .catch(error => {
            console.error('Errore registrazione Service Worker:', error);
          });
      }
    </script>
</head>
  <body class="prevent-overscroll">
    <!-- Root container -->
    <div 
      id="root" 
      class="scroll-container ios-safe-area-top ios-safe-area-bottom"
    ></div>

    <!-- Fallback per JavaScript disabilitato -->
    <noscript>
      <div style="padding: 20px; text-align: center;">
        JavaScript deve essere abilitato per utilizzare questa app.
      </div>
    </noscript>

    <!-- Offline fallback -->
    <div 
      id="offline-message" 
      style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
             background: #1e3a8a; color: white; padding: 12px 24px; border-radius: 8px; 
             box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 9999;"
    >
      Sei offline. Alcune funzionalità potrebbero non essere disponibili.
    </div>

    <!-- Script per il controllo della connettività -->
    <script>
      function updateOnlineStatus() {
        const offlineMessage = document.getElementById('offline-message');
        if (!navigator.onLine) {
          offlineMessage.style.display = 'block';
        } else {
          offlineMessage.style.display = 'none';
        }
      }

      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      
      // Controllo iniziale
      document.addEventListener('DOMContentLoaded', updateOnlineStatus);
    </script>

    <!-- Script per la gestione degli errori -->
    <script>
      window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Errore:', {
          message: msg,
          url: url,
          line: lineNo,
          column: columnNo,
          error: error
        });
        return false;
      };

      // Gestione errori non catturati delle Promise
      window.addEventListener('unhandledrejection', function(event) {
        console.error('Promessa non gestita:', event.reason);
      });
    </script>
  </body>
</html>
